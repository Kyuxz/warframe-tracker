<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Warframe World State Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* (Kept the same styling as original) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root{
            --bg-primary:#0d0d0d; --bg-secondary:#1a1a1a; --bg-card:#1e1e1e; --bg-card-hover:#252525;
            --accent-gold:#c9a227; --accent-blue:#00bfff; --accent-green:#4ade80; --accent-red:#ef4444;
            --accent-orange:#f97316; --accent-purple:#a855f7;
            --text-primary:#e5e5e5; --text-secondary:#9ca3af; --text-muted:#6b7280; --border-color:#2d2d2d;
            --glow-gold:0 0 20px rgba(201,162,39,0.3);
        }
        body{
            font-family:'Roboto',sans-serif;
            background:var(--bg-primary);
            color:var(--text-primary);
            min-height:100vh;
            line-height:1.6;
        }
        .header{ background:linear-gradient(135deg,var(--bg-secondary) 0%,#0a0a0a 100%); border-bottom:1px solid var(--border-color); padding:1rem 2rem; position:sticky; top:0; z-index:100; backdrop-filter:blur(10px); }
        .header-content{ max-width:1600px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem; }
        .logo{ font-family:'Rajdhani',sans-serif; font-size:1.8rem; font-weight:700; color:var(--accent-gold); text-transform:uppercase; letter-spacing:2px; display:flex; align-items:center; gap:0.5rem; }
        .logo-icon{ width:40px; height:40px; background:linear-gradient(135deg,var(--accent-gold),#b8860b); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1.5rem; }
        .search-container{ flex:1; max-width:500px; min-width:250px; }
        .search-wrapper{ position:relative; display:flex; align-items:center; }
        .search-icon{ position:absolute; left:1rem; color:var(--text-muted); font-size:1.2rem; }
        .search-input{ width:100%; padding:0.875rem 1rem 0.875rem 3rem; background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; color:var(--text-primary); font-size:1rem; transition:all 0.3s ease; }
        .search-input:focus{ outline:none; border-color:var(--accent-gold); box-shadow:var(--glow-gold); }
        .search-input::placeholder{ color:var(--text-muted); }
        .status-bar{ display:flex; align-items:center; gap:1rem; flex-wrap:wrap; }
        .status-item{ display:flex; align-items:center; gap:0.5rem; font-size:0.875rem; color:var(--text-secondary); }
        .status-dot{ width:8px; height:8px; border-radius:50%; background:var(--accent-green); animation:pulse 2s infinite; }
        @keyframes pulse{ 0%,100%{ opacity:1 } 50%{ opacity:0.5 } }
        .main-container{ max-width:1600px; margin:0 auto; padding:2rem; }
        .dashboard-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(350px,1fr)); gap:1.5rem; }
        .card{ background:var(--bg-card); border-radius:16px; border:1px solid var(--border-color); overflow:hidden; transition:all 0.3s ease; }
        .card:hover{ border-color:var(--accent-gold); box-shadow:var(--glow-gold); transform:translateY(-2px); }
        .card-header{ padding:1rem 1.25rem; background:linear-gradient(135deg, rgba(201,162,39,0.1) 0%, transparent 100%); border-bottom:1px solid var(--border-color); display:flex; align-items:center; justify-content:space-between; }
        .card-title{ font-family:'Rajdhani',sans-serif; font-size:1.25rem; font-weight:600; color:var(--accent-gold); text-transform:uppercase; letter-spacing:1px; display:flex; align-items:center; gap:0.5rem; }
        .card-timer{ background:rgba(0,191,255,0.15); color:var(--accent-blue); padding:0.25rem 0.75rem; border-radius:20px; font-size:0.875rem; font-weight:500; font-family:'Rajdhani',sans-serif; }
        .card-content{ padding:1.25rem; }
        .env-grid{ display:grid; gap:0.75rem; }
        .env-item{ display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; background:var(--bg-secondary); border-radius:10px; transition:all 0.2s ease; }
        .env-item:hover{ background:var(--bg-card-hover); }
        .env-name{ font-weight:500; color:var(--text-primary); }
        .env-status{ display:flex; align-items:center; gap:0.5rem; }
        .env-state{ padding:0.25rem 0.625rem; border-radius:6px; font-size:0.8rem; font-weight:500; text-transform:capitalize; }
        .env-state.day{ background:rgba(251,191,36,0.2); color:#fbbf24; }
        .env-state.night{ background:rgba(99,102,241,0.2); color:#818cf8; }
        .env-state.cold{ background:rgba(56,189,248,0.2); color:#38bdf8; }
        .env-state.warm{ background:rgba(251,146,60,0.2); color:#fb923c; }
        .env-timer{ font-size:0.875rem; color:var(--text-secondary); font-family:'Rajdhani',sans-serif; }
        .fissure-grid{ display:grid; gap:0.5rem; }
        .fissure-item{ display:flex; align-items:center; gap:1rem; padding:0.75rem 1rem; background:var(--bg-secondary); border-radius:10px; transition:all 0.2s ease; }
        .fissure-tier{ min-width:70px; padding:0.375rem 0.75rem; border-radius:6px; font-weight:600; font-size:0.8rem; text-align:center; text-transform:uppercase; }
        .fissure-tier.lith{ background:rgba(180,83,9,0.2); color:#d97706; }
        .fissure-tier.meso{ background:rgba(234,179,8,0.2); color:#eab308; }
        .fissure-tier.neo{ background:rgba(34,197,94,0.2); color:#22c55e; }
        .fissure-tier.axi{ background:rgba(14,165,233,0.2); color:#0ea5e9; }
        .fissure-info{ flex:1; }
        .fissure-mission{ font-weight:500; color:var(--text-primary); margin-bottom:0.125rem; }
        .fissure-location{ font-size:0.85rem; color:var(--text-muted); }
        .fissure-timer{ font-size:0.875rem; color:var(--accent-blue); font-family:'Rajdhani',sans-serif; }
        .loading{ display:flex; flex-direction:column; align-items:center; justify-content:center; padding:3rem; color:var(--text-muted); }
        .loading-spinner{ width:40px; height:40px; border:3px solid var(--border-color); border-top-color:var(--accent-gold); border-radius:50%; animation:spin 1s linear infinite; margin-bottom:1rem; }
        @keyframes spin{ to{ transform:rotate(360deg); } }
        .empty-state{ text-align:center; padding:2rem; color:var(--text-muted); }
        .news-list{ display:flex; flex-direction:column; gap:0.5rem; max-height:300px; overflow-y:auto; }
        .news-item{ display:flex; align-items:flex-start; gap:0.75rem; padding:0.75rem; background:var(--bg-secondary); border-radius:10px; transition:all 0.2s ease; text-decoration:none; color:inherit; }
        .news-date{ min-width:40px; padding:0.25rem 0.5rem; background:rgba(201,162,39,0.15); color:var(--accent-gold); border-radius:6px; font-size:0.75rem; font-weight:500; text-align:center; }
        .news-title{ color:var(--text-primary); font-size:0.9rem; line-height:1.4; }
        @media (max-width:768px){
            .header{ padding:1rem; }
            .header-content{ flex-direction:column; align-items:stretch; }
            .logo{ justify-content:center; }
            .search-container{ max-width:100%; }
            .status-bar{ justify-content:center; }
            .main-container{ padding:1rem; }
            .dashboard-grid{ grid-template-columns:1fr; }
            .card-header{ flex-direction:column; align-items:flex-start; gap:0.5rem; }
        }
        .filter-tabs{ display:flex; gap:0.5rem; padding:1rem 2rem; background:var(--bg-secondary); overflow-x:auto; border-bottom:1px solid var(--border-color); }
        .filter-tab{ padding:0.5rem 1rem; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-secondary); cursor:pointer; transition:all 0.2s ease; white-space:nowrap; font-size:0.9rem; }
        .filter-tab:hover{ border-color:var(--accent-gold); color:var(--accent-gold); }
        .filter-tab.active{ background:rgba(201,162,39,0.15); border-color:var(--accent-gold); color:var(--accent-gold); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">‚öî</div>
                Warframe Tracker
            </div>

            <div class="search-container">
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search missions, fissures, alerts..." autocomplete="off">
                </div>
            </div>

            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="liveDot"></span>
                    <span>Live Data</span>
                </div>
                <div class="status-item" id="lastUpdate">Updated: --</div>
            </div>
        </div>
    </header>

    <div class="filter-tabs" id="filterTabs">
        <button class="filter-tab active" data-filter="all">All</button>
        <button class="filter-tab" data-filter="environments">Environments</button>
        <button class="filter-tab" data-filter="fissures">Void Fissures</button>
        <button class="filter-tab" data-filter="missions">Missions</button>
        <button class="filter-tab" data-filter="invasions">Invasions</button>
        <button class="filter-tab" data-filter="events">Events & Alerts</button>
    </div>

    <main class="main-container">
        <div class="dashboard-grid" id="dashboard">
            <div class="loading">
                <div class="loading-spinner"></div>
                <span>Loading world state...</span>
            </div>
        </div>
    </main>

    <script>
        // API endpoint for Warframe worldstate (PC)
        const API_URL = 'https://api.warframestat.us/pc';
        let worldState = null;
        let timerInterval = null;

        // Utilities
        function formatTime(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '--';
            if (seconds < 0) return 'Expired';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return \\`${h}h ${m}m ${s}s\
            if (m > 0) return \\`${m}m ${s}s\
            return \\`${s}s\
        }

        function getTimeRemaining(expiry) {
            if (!expiry) return NaN;
            const end = new Date(expiry).getTime();
            const now = Date.now();
            return Math.floor((end - now) / 1000);
        }

        function safeExpiry(obj, ...keys) {
            for (const k of keys) {
                if (obj && obj[k]) return obj[k];
            }
            return obj && obj.expiry ? obj.expiry : null;
        }

        function capitalize(str){
            return str ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : '';
        }

        // Fetch world state
        async function fetchWorldState(){
            try{
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('Failed to fetch world state: ' + res.status);
                worldState = await res.json();
                renderDashboard();
                updateLastUpdateTime();
            } catch (error){
                console.error('Error fetching world state:', error);
                // Fixed: use concatenated string (no broken template literal) and hook up retry button
                document.getElementById('dashboard').innerHTML =
                    '<div class="empty-state">' +
                        '<p>Failed to load world state. Please try again later.</p>' +
                        '<button id="retryBtn" style="margin-top:1rem; padding:0.5rem 1rem; background:var(--accent-gold); border:none; border-radius:8px; cursor:pointer; color:#000;">Retry</button>' +
                    '</div>';
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) retryBtn.addEventListener('click', () => {
                    // show loading
                    document.getElementById('dashboard').innerHTML = '<div class="loading"><div class="loading-spinner"></div><span>Loading world state...</span></div>';
                    fetchWorldState();
                });
            }
        }

        function updateLastUpdateTime(){
            const el = document.getElementById('lastUpdate');
            if (el) el.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
        }

        // Rendering
        function renderDashboard(){
            const dashboard = document.getElementById('dashboard');
            if (!dashboard) return;
            // Build cards HTML
            let html = '';

            html += renderEnvironments();
            html += renderFissures();
            html += renderSortie();
            html += renderInvasions();
            html += renderAlerts();
            html += renderNews();

            dashboard.innerHTML = html;

            // Start timers to refresh countdowns every second
            startTimers();
        }

        function renderEnvironments(){
            const cycles = [];
            // Earth / Plains (cetus/earthCycle sometimes under cetusCycle or earthCycle)
            if (worldState.cetusCycle) {
                cycles.push({ name: 'Cetus / Plains of Eidolon', state: worldState.cetusCycle.isDay ? 'day' : 'night', expiry: worldState.cetusCycle.expiry });
            } else if (worldState.earthCycle) {
                cycles.push({ name: 'Plains of Eidolon / Earth', state: worldState.earthCycle.isDay ? 'day' : 'night', expiry: worldState.earthCycle.expiry });
            }

            if (worldState.vallisCycle) cycles.push({ name: 'Orb Vallis', state: worldState.vallisCycle.isWarm ? 'warm' : 'cold', expiry: worldState.vallisCycle.expiry });
            if (worldState.cambionCycle) cycles.push({ name: 'Cambion Drift', state: (worldState.cambionCycle.active || '').toLowerCase(), expiry: worldState.cambionCycle.expiry });
            if (worldState.duviriCycle) cycles.push({ name: 'Duviri', state: worldState.duviriCycle.state || 'unknown', expiry: worldState.duviriCycle.expiry });

            let out = '<div class="card">' +
                '<div class="card-header"><div class="card-title">Environments</div><div class="card-timer">Real-time</div></div>' +
                '<div class="card-content"><div class="env-grid">';

            if (!cycles.length) {
                out += '<div class="empty-state">No environment data available.</div>';
            } else {
                cycles.forEach((c, idx) => {
                    const secs = getTimeRemaining(c.expiry);
                    out += `<div class="env-item">
                        <div class="env-name">${c.name}</div>
                        <div class="env-status">
                            <div class="env-state ${c.state}">${capitalize(c.state)}</div>
                            <div class="env-timer" data-expiry="${encodeURIComponent(c.expiry)}" id="env-timer-${idx}">${formatTime(secs)}</div>
                        </div>
                    </div>`;
                });
            }

            out += '</div></div></div>';
            return out;
        }

        function fissureTierClass(tier) {
            if (!tier) return 'lith';
            const t = tier.toLowerCase();
            if (t.includes('lith')) return 'lith';
            if (t.includes('meso')) return 'meso';
            if (t.includes('neo')) return 'neo';
            if (t.includes('axi')) return 'axi';
            if (t.includes('requiem')) return 'requiem';
            if (t.includes('omnia')) return 'omnia';
            return t;
        }

        function renderFissures(){
            const fissures = Array.isArray(worldState.fissures) ? worldState.fissures.slice(0, 8) : [];
            let out = '<div class="card">' +
                '<div class="card-header"><div class="card-title">Void Fissures</div><div class="card-timer">Remaining</div></div>' +
                '<div class="card-content"><div class="fissure-grid">';
            if (!fissures.length) {
                out += '<div class="empty-state">No current fissures.</div>';
            } else {
                fissures.forEach((f, idx) => {
                    const tier = f.tier || f.tierChance || f.tierName || f.tierType || 'Lith';
                    const missionType = f.missionType || (f.definition && f.definition.type) || (f.mission && f.mission.type) || (f.completion || '');
                    const node = f.node || f.location || f.name || 'Unknown';
                    const expiry = f.expiry || f.expiredAt || f.activation || f.expiration || null;
                    const secs = getTimeRemaining(expiry);
                    out += `<div class="fissure-item">
                        <div class="fissure-tier ${fissureTierClass(tier)}">${tier}</div>
                        <div class="fissure-info">
                            <div class="fissure-mission">${missionType || 'Unknown Mission'}</div>
                            <div class="fissure-location">${node}</div>
                        </div>
                        <div class="fissure-timer" data-expiry="${encodeURIComponent(expiry)}" id="fissure-timer-${idx}">${formatTime(secs)}</div>
                    </div>`;
                });
            }
            out += '</div></div></div>';
            return out;
        }

        function renderSortie(){
            const s = worldState.sortie || worldState.sorties || null;
            let out = '<div class="card">' +
                '<div class="card-header"><div class="card-title">Sortie</div><div class="card-timer">Status</div></div>' +
                '<div class="card-content">';
            if (!s) {
                out += '<div class="empty-state">No sortie active.</div>';
            } else {
                // sortie structure varies; try common fields
                const boss = s.boss || s.bosses || (s.variants && s.variants[0] && s.variants[0].boss) || 'Unknown';
                const expiry = s.expiry || s.activation || s.end || s.activatedAt || null;
                const desc = s.variants ? s.variants.map(v => \\`${v.missionType} (${v.modifier || ''})\
                ).join('<br>') : (s.missions ? s.missions.map(m => m.type).join('<br>') : (s.variants && s.variants.length ? s.variants[0].missionType : '---'));
                const secs = getTimeRemaining(expiry);
                out += `<div class="sortie-mission">
                            <div class="sortie-type">${boss}</div>
                            <div class="sortie-modifier">${desc}</div>
                            <div class="mission-timer" data-expiry="${encodeURIComponent(expiry)}" id="sortie-timer">${formatTime(secs)}</div>
                        </div>`;
            }
            out += '</div></div>';
            return out;
        }

        function renderInvasions(){
            const invasions = Array.isArray(worldState.invasions) ? worldState.invasions.slice(0,6) : [];
            let out = '<div class="card">' +
                '<div class="card-header"><div class="card-title">Invasions</div><div class="card-timer">Progress</div></div>' +
                '<div class="card-content">';
            if (!invasions.length) {
                out += '<div class="empty-state">No invasions currently.</div>';
            } else {
                out += '<div class="invasion-list">';
                invasions.forEach(inv => {
                    const node = inv.node || inv.location || 'Unknown';
                    const count = inv.count || inv.completion || 0;
                    const total = inv.total || inv.required || 100;
                    const progress = Math.min(100, Math.round((count / total) * 100));
                    const rewards = (inv.attackerReward && inv.attackerReward.asString) ? inv.attackerReward.asString : (inv.attackerReward ? JSON.stringify(inv.attackerReward) : '--');
                    out += `<div class="invasion-item">
                                <div class="invasion-node">${node}</div>
                                <div class="invasion-progress">
                                    <div class="invasion-bar"><div class="invasion-fill" style="width:${progress}%"></div></div>
                                    <div style="min-width:45px; text-align:right;">${progress}%</div>
                                </div>
                                <div class="invasion-rewards">Rewards: ${rewards}</div>
                            </div>`;
                });
                out += '</div>';
            }
            out += '</div></div>';
            return out;
        }

        function renderAlerts(){
            const alerts = Array.isArray(worldState.alerts) ? worldState.alerts.slice(0,6) : [];
            let out = '<div class="card">' +
                '<div class="card-header"><div class="card-title">Alerts & Events</div><div class="card-timer">Active</div></div>' +
                '<div class="card-content">';
            if (!alerts.length) {
                out += '<div class="empty-state">No alerts or events.</div>';
            } else {
                out += '<div class="mission-list">';
                alerts.forEach((a, idx) => {
                    const missionType = a.mission && a.mission.type ? a.mission.type : (a.type || 'Alert');
                    const location = a.node || (a.mission && (a.mission.location || a.mission.node)) || 'Unknown';
                    const expiry = a.expiry || a.expiration || a.end || null;
                    const secs = getTimeRemaining(expiry);
                    out += `<div class="mission-item">
                                <div class="mission-type">${missionType} <span class="mission-faction">${a.faction || ''}</span></div>
                                <div class="mission-details">${a.reward ? (a.reward.asString || JSON.stringify(a.reward)) : (a.modifier || '')}</div>
                                <div class="mission-location">${location}</div>
                                <div class="mission-timer" data-expiry="${encodeURIComponent(expiry)}" id="alert-timer-${idx}">${formatTime(secs)}</div>
                            </div>`;
                });
                out += '</div>';
            }
            out += '</div></div>';
            return out;
        }

        function renderNews(){
            const news = Array.isArray(worldState.news) ? worldState.news.slice(0,8) : [];
            let out = '<div class="card">' +
                '<div class="card-header"><div class="card-title">News</div><div class="card-timer">Latest</div></div>' +
                '<div class="card-content">';
            if (!news.length) {
                out += '<div class="empty-state">No news available.</div>';
            } else {
                out += '<div class="news-list">';
                news.forEach(n => {
                    const date = n.date || n.posted || '';
                    const short = n.message ? (n.message.length > 140 ? n.message.slice(0,140) + '‚Ä¶' : n.message) : (n.body || '');
                    out += `<a class="news-item" href="${n.link || '#'}" target="_blank" rel="noopener noreferrer">
                                <div class="news-date">${date ? (new Date(date).toLocaleDateString()) : ''}</div>
                                <div class="news-title">${n.title || short}</div>
                            </a>`;
                });
                out += '</div>';
            }
            out += '</div></div>';
            return out;
        }

        // Timers updater - will refresh any element with data-expiry attribute
        function updateCountdowns() {
            const els = document.querySelectorAll('[data-expiry]');
            els.forEach(el => {
                const raw = el.getAttribute('data-expiry');
                if (!raw) return;
                const expiry = decodeURIComponent(raw);
                const secs = getTimeRemaining(expiry);
                el.textContent = formatTime(secs);
            });
        }

        function startTimers(){
            // clear existing
            if (timerInterval) clearInterval(timerInterval);
            updateCountdowns();
            timerInterval = setInterval(() => {
                updateCountdowns();
                updateLastUpdateTime();
            }, 1000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchWorldState();

            // Minimal search filter behavior (client-side)
            const search = document.getElementById('searchInput');
            if (search) {
                search.addEventListener('input', (e) => {
                    const q = e.target.value.trim().toLowerCase();
                    const dashboard = document.getElementById('dashboard');
                    if (!dashboard) return;
                    if (!q) {
                        // re-render full dashboard from latest worldState
                        renderDashboard();
                        return;
                    }
                    // naive filter: hide cards that don't contain query
                    // simple text search through innerText of each top-level card
                    const cards = dashboard.querySelectorAll('.card');
                    cards.forEach(card => {
                        const text = card.innerText.toLowerCase();
                        card.style.display = text.includes(q) ? '' : 'none';
                    });
                });
            }

            // Filter tabs (basic)
            const tabs = document.querySelectorAll('.filter-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', (ev) => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const filter = tab.getAttribute('data-filter');
                    const dashboard = document.getElementById('dashboard');
                    if (!dashboard) return;
                    const cards = dashboard.querySelectorAll('.card');
                    cards.forEach(card => {
                        if (filter === 'all') {
                            card.style.display = '';
                        } else {
                            const title = card.querySelector('.card-title') ? card.querySelector('.card-title').innerText.toLowerCase() : '';
                            card.style.display = title.includes(filter) ? '' : 'none';
                        }
                    });
                });
            });
        });

        // Make sure to clear interval on unload
        window.addEventListener('beforeunload', () => {
            if (timerInterval) clearInterval(timerInterval);
        });
    </script>
</body>
</html>