<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Warframe Tracker — Node Proxy</title>
<style>
  body{font-family:Inter,system-ui,Arial;background:#050507;color:#eaeaea;margin:0}
  header{padding:12px;background:#0b0d10;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:1rem}
  input{padding:8px;border-radius:6px;border:1px solid #222;background:#0b0d10;color:#eaeaea;min-width:220px}
  button{padding:8px 10px;border-radius:6px;border:none;background:#1f6feb;color:white;cursor:pointer}
  .container{padding:12px;max-width:1100px;margin:0 auto}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
  .card{background:#0c0e11;padding:12px;border-radius:8px;border:1px solid #16181c}
  pre{white-space:pre-wrap;word-break:break-word;font-size:0.85rem}
  .muted{color:#9aa0b4;font-size:0.9rem}
  @media (max-width:640px){header{padding:10px} .container{padding:8px}}
</style>
</head>
<body>
<header>
  <h1>Warframe Tracker (Node proxy)</h1>
  <div style="flex:1"></div>
  <input id="q" placeholder="Search (e.g. arbitration, Baro, fissures)"/>
  <button id="search">Search</button>
  <button id="refresh">Refresh</button>
</header>

<div class="container">
  <div id="status" class="muted">Ready.</div>
  <div id="grid" class="grid" style="margin-top:12px"></div>
</div>

<script>
const grid = document.getElementById('grid');
const status = document.getElementById('status');
const qInput = document.getElementById('q');

function setStatus(t){ status.textContent = t; }

function card(title, html){ return `<div class="card"><strong>${title}</strong><div style="margin-top:10px">${html}</div></div>`; }

async function fetchApi(path){
  const res = await fetch(`/api/${path}`);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

function renderJsonAsSummary(obj){
  // small readable summary: show some keys, else full JSON
  try{
    if(!obj) return '<div class="muted">None</div>';
    if(Array.isArray(obj) && obj.length === 0) return '<div class="muted">None</div>';
    if(typeof obj === 'object'){
      // if it's a fissures list, show first 6
      if(Array.isArray(obj)){
        const sample = obj.slice(0,6).map(i=>`<div class="muted">${i.tier || ''} ${i.missionType || ''} · ${i.node || ''}</div>`).join('');
        return sample + (obj.length>6?`<div class="muted">+ ${obj.length-6} more</div>` : '');
      }
      // small object: pretty-print some fields
      return `<pre>${JSON.stringify(obj,null,2)}</pre>`;
    }
    return `<div>${String(obj)}</div>`;
  }catch(e){
    return `<pre>${escapeHtml(String(obj))}</pre>`;
  }
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function loadDashboard(){
  setStatus('Loading dashboard...');
  grid.innerHTML = '';
  try{
    const [fissures, alerts, invasions, sortie, voidTrader] = await Promise.all([
      fetchApi('fissures').catch(()=>[]),
      fetchApi('alerts').catch(()=>[]),
      fetchApi('invasions').catch(()=>[]),
      fetchApi('sortie').catch(()=>null),
      fetchApi('voidTrader').catch(()=>null)
    ]);
    grid.insertAdjacentHTML('beforeend', card('Fissures', renderJsonAsSummary(fissures)));
    grid.insertAdjacentHTML('beforeend', card('Alerts', renderJsonAsSummary(alerts)));
    grid.insertAdjacentHTML('beforeend', card('Invasions', renderJsonAsSummary(invasions)));
    grid.insertAdjacentHTML('beforeend', card('Sortie', renderJsonAsSummary(sortie)));
    grid.insertAdjacentHTML('beforeend', card('Baro (Void Trader)', renderJsonAsSummary(voidTrader)));
    setStatus('Dashboard loaded');
  }catch(err){
    setStatus('Dashboard error: ' + err.message);
    grid.innerHTML = `<div class="card"><pre>${escapeHtml(err.stack || err.message)}</pre></div>`;
  }
}

async function doSearch(){
  const q = qInput.value.trim();
  if(!q){ setStatus('Type something to search'); return; }
  setStatus('Searching remote API...');
  grid.innerHTML = '';
  try{
    const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`).then(r=>r.json());
    setStatus(`Search done — matches: ${Object.keys(res.matches||{}).length}`);
    const matches = res.matches || {};
    if(Object.keys(matches).length === 0){
      grid.innerHTML = `<div class="card"><div class="muted">No results for "${escapeHtml(q)}"</div></div>`;
      return;
    }
    for(const [k,v] of Object.entries(matches)){
      grid.insertAdjacentHTML('beforeend', card(k, `<pre>${escapeHtml(JSON.stringify(v,null,2))}</pre>`));
    }
  }catch(err){
    setStatus('Search failed: ' + err.message);
    grid.innerHTML = `<div class="card"><pre>${escapeHtml(err.stack || err.message)}</pre></div>`;
  }
}

document.getElementById('search').addEventListener('click', ()=>doSearch());
qInput.addEventListener('keydown', e => { if(e.key==='Enter') doSearch(); });
document.getElementById('refresh').addEventListener('click', ()=>loadDashboard());

loadDashboard();
</script>
</body>
</html>
